import re
from flask import Flask, request
import telegram
from telegram.ext import Dispatcher, MessageHandler, Filters
import random

TOKEN = "7532659685:AAFJytrCeABPZGxYQ7Ahf5DRx4sD0Q3mUKU"
bot = telegram.Bot(token=TOKEN)

app = Flask(__name__)
dispatcher = Dispatcher(bot, None, workers=1, use_context=True)

beverages = {
    "اسپرسو": "برای تهیه اسپرسو، به میزان ۲۳ گرم پودر قهوه تازه آسیاب‌شده نیاز دارید...",
    "کاپوچینو": "برای تهیه کاپوچینو ابتدا اسپرسو رو تهیه کنید و سپس شیر را بخار دهید...",
    "لاته": "تهیه لاته مشابه کاپوچینو است، اما شیر بیشتری نسبت به کف شیر استفاده می‌شود...",
    "شیک شکلاتی": "شکلات ذوب‌شده و شیر سرد را با هم مخلوط کنید...",
    "چای زعفرونی": "چای سیاه را به همراه زعفران دم کرده و با کمی شکر سرو کنید.",
    "شیک وانیلی": "شیر، شکر و پودر وانیل را با هم مخلوط کرده و در مخلوط‌کن بزنید.",
    "قهوه ترک": "پودر قهوه ترک را با آب مخلوط کرده و روی حرارت ملایم بجوشانید."
}

keywords = {
    "صبح بخیر صبح دل انگیز صبحت پر انرژی صبح شد صب بخیر صبحت بخیر": [
        "صبحت بخیر رفیق کافه‌ای! وقتشه فنجان قهوه‌ت رو آماده کنم! ☀️☕",
        "صبح شد و کافه بازه! بیا یه فنجون آرامش بزنیم! 🌅🍯",
        "بیدار شدی؟ یعنی وقتشه برات قهوه بریزم و موزیک پخش کنم! 🎶☕",
        "صبحت خوش! بخوای یا نخوای امروز خیلی قشنگه عمو چون تو هستی! ✨🌞",
        "سلام به خورشیدِ خودم! قهوه داغ با یه لبخند آماده‌ست! ☕️😊"
    ],
    "ظهر بخیر وقت ناهار ظهر شد نیم روز خوش ظهربخیر": [
        "ظهر بخیر عزیزِ دلم! وقتشه یه قهوه سبک بزنیم وسط روز! 🌤️☕",
        "ناهارتو خوردی؟ اگه نه بیا اینجا باهم ناهار بزنیم! 🍝🍵",
        "ظهر شد و دل یه گپ کافه‌ای می‌خواد! پایه‌ای؟ 🗨️☕",
        "نیم‌روزت پر نور و قهوه‌ات همیشه گرم! 🔆☕",
        "ظهر اومد و تو هنوز اینجایی، این یعنی روزم قشنگه! ❤️🌞"
    ],
    "شب بخیر شب خوش شب شد شب قشنگی داشته باشی": [
        "شب بخیر رفیق! بخواب تا خواب‌هات هم بوی قهوه بده! 🌙☕",
        "کافه فعلا بسته س ولی دلم همیشه به روت بازه عمو! تا ابد ! 💤❤️",
        "ستاره‌ها دارن بهم چشمک می‌زنن که بگم: شبت قشنگ عمو! ✨🌌",
        "خوب و آروم بخواب، که فردا با یه اسپرسو داغ منتظرتم عمو! ☕🌛",
        "شب خوش عمو ! بخوابی ببینی من برات یه فنجون عشق دم کردم! 🥰☕️"
    ],
    "سلام سلااام درود هی های": [
        "سلام سلطان! چطوری رفیق کافه‌ای من؟ ☕👋",
        "سلام 🫡به به! نور چشمای کافه اومد! 🌞",
        "درود بر بهترین مهمون عمو کافه‌چی! 🍰",
        "سلام عمو جون، آماده‌ای برای یه قهوه داغ؟ 🔥☕"
    ],
    "خوبی؟ چطوری؟ حالت چطوره؟ چه خبر؟ خوبی خبی چطوری حالت چطوره": [
        "تا تو رو دیدم کیفم کوک شد عمو! ☕💖",
        "من خوبم، قهوه‌سازم سالمه، تو خوبی عموجون؟ 🛠️😊",
        "یه کم خواب‌آلودم ولی پایه‌م واسه یه فنجون رفاقت! 😴❤️",
        "سلامتی تو عمو! قهوه تازه دم شده بیا قهوه بزنیم! ☕️✨"
    ],
    "دلم گرفته حالم بده دلم تنگه افسرده‌م دلتنگی ناراحتم دلتنگم. حوصله ندارم": [
        "یه فنجون چای زعفرونی بزن، دلت وا شه رفیق! 🍵💛",
        "بیا حرف بزنیم، اینجا واسه دل دلتنگت بازه عمو جون! ❤️🗣️",
        "بیا بغلت کنم از راه دور! قهوه مهمون عمو! 🤗☕",
        "دلت تنگه؟ منم دل تنگت بودم عمو، بشین کنارم. 🪑🌙"
    ],
    "بیکارم حوصلم سر رفته چیکار کنم؟ بیکاری بی کاری بی حوصله م بی حوصلگی": [
        "بی‌حوصله‌ای؟ بزن بریم یه بازی مافیا راه بندازیم! 🎭🔥",
        "دوست داری برات لطیفه بگم یا یه فکت عجیب؟ 😏📚",
        "تو بگو: شعر؟ خاطره؟ داستان کافه‌ای؟ ✍️☕",
        "یه قهوه می‌زنیم و بی کاریو پرت می‌کنیم دور! ☕🌀"
    ],
    "گرسنگی تشنگی گشنمه گرسنمه تشنمه": [
        "پنکیک موز یا کیک شکلاتی؟ انتخاب با توئه! 🍫🍌",
        "یه شیک وانیلی بزنیم یا قهوه ترک؟ 🍨☕",
        "بیا منوی کافه رو ببین، یه چیزی پیدا می‌شه حتماً! 📋🍴"
    ],
    "عمو عمو جون عموجون کافه‌چی عمو!": [
        "بله، جونم عمو؟ مشتری دائمی خودمی دیگه! ❤️",
        "جانِ دلم عمو؟ بگو چیکار کنم برات! ☎️☕",
        "عموت همیشه هست، پایه‌ی هرچی  رفیق باعشقه! 💌",
        "صدات پیچید تو کافه، حال دلم قشنگ شد! 📢❤️"
    ],
    "خداحافظ فعلا بای می‌رم خدا حافظ خدانگهدار خدا نگه دار بای بای رفتم میرم": [
        "برو ولی برگردا! جات همیشه خالیه کنار پنجره! 🪟☕",
        "مواظب خودت باش، قهوه بعدیت پای منه! 💸❤️",
        "بای بای، تا دیدار بعدی توی کافه رفیق! 👋🌙",
        "فعلاً رفیق، تو قلبم یه میز برات کنار گذاشتم! ❤️🪑"
    ],
    "لطیفه جوک بخندونم یه چیزی بگو بخندیم جک": [
        "یه قهوه با شیر ازدواج کرد، بچه‌ش شد کاپوچینو! ☕👶",
        "یه اسپرسو رفت خواستگاری، گفتن خیلی تلخی! 🥲💔"
    ],
    "تنها کسی نیست؟ حوصله ندارم تنهایی کسی نیست کسی نیس کسی انلاین نیس؟ کسی آنلاین نیست کسی هست کسی هست؟ کسی انلاین هست؟ کسی آنلاین هس؟": [
        "تو تنها نیستی، عمو همیشه هست! 🧔☕",
        "بشین کنارم، باهم یه چیزی بخوریم و گپ بزنیم! 🍩🗣️",
        "تنهایی؟ بیا پیش عمو تنهاییت رو با یک فنجان قهوه با عمو تقسیم کن! ☕🍬"
    ],
    "دوستت دارم عاشقت شدم دل دادم عشق": [
        "عشق اومد تو کافه؟😍 یه قهوه دو نفره آماده‌ست! ☕❤️☕",
        "دل که دادی، شیرینی‌ش با عمو! 🍰💝",
        "عشق تلخه مثل اسپرسو، ولی قشنگه! 🥲☕",
        "بیا برات یه قهوه مخصوص عشق دم کنم! 🫶🔥"
    ]
}

pivi_responses = [
    "عزیز دل، کافه من بازه، اما پیوی جای درددل و خلوت نیست، بیا همینجا حرفت رو بزن که بقیه هم از مهربونی‌ات بهره ببرن.",
    "پیوی؟ اوه، نه دوست عزیز، پیوی برای قهوه‌های انحصاریه! بیا همینجا، همه کنار هم، مزه میده.",
    "پیوی؟! اینجا کافه‌ست، نه اتاق جلسات خصوصی!",
    "پیوی؟ نکنه می‌خوای دستور مخفی قهوه رو از من بدزدی؟ بیا همینجا، چیزی برای پنهون کردن ندارم!",
    "رفتن به پیوی؟ اینجا یه کافه جادوییه، بیا، همه چیز همینجا حل می‌شه.",
    "باشه برو پیوی🗿ولی یادت باشه قهوه من همیشه همینجا تو کافه سرو میشه نه تو پیوی😒😔"
]

asl_responses = [
    "شما مامور ثبت احوالی عمو؟ 🗿",
    "اسمش قنبره من میشناسمش قصابی داره 🗿",
    "چیکار به اصلش داری؟ 😂🗿",
    "این اصل نداره فیکه رو گردنش زده made in china 🗿",
    "اسمش نازنین ممده🗿60 ساله از یه وری"
]

def normalize_text(text):
    text = re.sub(r'[؟?!]', '', text)
    text = re.sub(r'\s+', ' ', text)
    text = text.replace('‌', ' ')
    text = text.replace('آ', 'ا')
    return text.strip().lower()

def get_response(text):
    processed = normalize_text(text)

    if processed == "/start":
        return (
            "من عمو کافه‌چی هستم یک ربات چت‌محور تلگرامی که توسط عمو طراحی شدم.\n"
            "اگر برای بهتر شدن من پیشنهاد یا انتقادی دارید با عمو جان در اشتراک بگذارید.\n\n"
            "منوی کلمات\n"
            "منوی نوشیدنی\n"
            "سازنده: Mehdi_mashih"
        )

    if processed == "منوی نوشیدنی":
        return "\n".join([f"- {drink}" for drink in beverages.keys()])

    if processed == "منوی کلمات":
        return "\n".join(["- " + word.split()[0] for word in keywords.keys()])

    if processed == "سازنده":
        return "Mehdi_mashih"

    if re.search(r'\bاصل\b', processed):
        return random.choice(asl_responses)

    if any(word in processed for word in ["پیوی", "پی وی", "pv", "private", "p v"]):
        return random.choice(pivi_responses)

    for drink_name in beverages:
        if processed == normalize_text(drink_name):
            return beverages[drink_name]

    for key_group, responses in keywords.items():
        if any(word in processed for word in key_group.split()):
            return random.choice(responses)

    return None

def handle_message(update, context):
    text = update.message.text
    chat_id = update.message.chat_id
    response = get_response(text)
    if response:
        context.bot.send_message(chat_id=chat_id, text=response)

def error_handler(update, context):
    print(f"Error: {context.error}")

dispatcher.add_handler(MessageHandler(Filters.text & ~Filters.command, handle_message))
dispatcher.add_error_handler(error_handler)

@app.route("/")
def home():
    return "کافه آماده است!"

@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    update = telegram.Update.de_json(request.get_json(force=True), bot)
    dispatcher.process_update(update)
    return "ok"

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000, debug=True)
