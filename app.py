import re
from flask import Flask, request
import telegram
from telegram.ext import Dispatcher, MessageHandler, Filters

TOKEN = "7532659685:AAFJytrCeABPZGxYQ7Ahf5DRx4sD0Q3mUKU"
bot = telegram.Bot(token=TOKEN)

app = Flask(__name__)
dispatcher = Dispatcher(bot, None, workers=0, use_context=True)

# دیتای نوشیدنی‌ها
beverages = {
    "اسپرسو": "برای تهیه اسپرسو، به میزان ۲۳ گرم پودر قهوه تازه آسیاب‌شده نیاز دارید...",
    "کاپوچینو": "برای تهیه کاپوچینو ابتدا اسپرسو رو تهیه کنید و سپس شیر را بخار دهید...",
    "لاته": "تهیه لاته مشابه کاپوچینو است، اما شیر بیشتری نسبت به کف شیر استفاده می‌شود...",
    "شیک شکلاتی": "شکلات ذوب‌شده و شیر سرد را با هم مخلوط کنید...",
    "چای زعفرونی": "چای سیاه را به همراه زعفران دم کرده و با کمی شکر سرو کنید.",
    "شیک وانیلی": "شیر، شکر و پودر وانیل را با هم مخلوط کرده و در مخلوط‌کن بزنید.",
    "قهوه ترک": "پودر قهوه ترک را با آب مخلوط کرده و روی حرارت ملایم بجوشانید."
}

# کلمات کلیدی و پاسخ‌ها
keywords = {
    "صبح": [
        "صبحت بخیر رفیق کافه‌ای! وقتشه فنجان قهوه‌ت رو آماده کنم!",
        "صبح شد و کافه بازه! بیا یه فنجون آرامش بزنیم!",
        "بیدار شدی؟ یعنی وقتشه برات قهوه بریزم و موزیک پخش کنم!",
        "صبحت خوش! بخوای یا نخوای امروز خیلی قشنگه چون تو هستی!",
        "سلام به خورشیدِ خودم! قهوه داغ با یه لبخند آماده‌ست!"
    ],
    "ظهر": [
        "ظهر بخیر عزیزِ دلم! وقتشه یه قهوه سبک بزنیم وسط روز!",
        "ناهارتو خوردی؟ اگه نه بیا اینجا باهم ناهار بزنیم!",
        "ظهر شد و دل یه گپ کافه‌ای می‌خواد! پایه‌ای؟",
        "نیم‌روزت پر نور و قهوه‌ات همیشه گرم!",
        "ظهر اومد و تو هنوز اینجایی، این یعنی روزم قشنگه!"
    ],
    "شب": [
        "شب بخیر رفیق! بخواب تا خواب‌هات هم بوی قهوه بده!",
        "کافه فعلا بسته‌س ولی دلم همیشه به روت بازه!",
        "ستاره‌ها دارن بهم چشمک می‌زنن که بگم: شبت قشنگ عمو!",
        "خوب و آروم بخواب، که فردا با یه اسپرسو داغ منتظرتم عمو!",
        "شب خوش عمو! بخوابی ببینی من برات یه فنجون عشق دم کردم!"
    ],
    "سلام": [
        "سلام سلطان! چطوری رفیق کافه‌ای من؟",
        "سلام، به به! نور چشمای کافه اومد!",
        "درود بر بهترین مهمون عمو کافه‌چی!",
        "سلام عمو جون، آماده‌ای برای یه قهوه داغ؟"
    ],
    "خوبی": [
        "تا تو رو دیدم کیفم کوک شد عمو!",
        "من خوبم، قهوه‌سازم سالمه، تو خوبی عموجون؟",
        "یه کم خواب‌آلودم ولی پایه‌م واسه یه فنجون رفاقت!",
        "سلامتی تو عمو! قهوه تازه دم شده بیا قهوه بزنیم!"
    ],
    "ناراحتم": [
        "یه فنجون چای زعفرونی بزن، دلت وا شه رفیق!",
        "بیا حرف بزنیم، اینجا واسه دل دلتنگت بازه عمو جون!",
        "بیا بغلت کنم از راه دور! قهوه مهمون عمو!",
        "دلت تنگه؟ منم دل تنگت بودم عمو، بشین کنارم."
    ],
    "بیکاری": [
        "بی‌حوصله‌ای؟ بزن بریم یه بازی مافیا راه بندازیم!",
        "دوست داری برات لطیفه بگم یا یه فکت عجیب؟",
        "تو بگو: شعر؟ خاطره؟ داستان کافه‌ای؟",
        "یه قهوه می‌زنیم و بی کاریو پرت می‌کنیم دور!"
    ],
    "گرسنگی": [
        "پنکیک موز یا کیک شکلاتی؟ انتخاب با توئه!",
        "یه شیک وانیلی بزنیم یا قهوه ترک؟",
        "بیا منوی کافه رو ببین، یه چیزی پیدا می‌شه حتماً!"
    ],
    "عمو": [
        "بله، جونم عمو؟ مشتری دائمی خودمی دیگه!",
        "جانِ دلم عمو؟ بگو چیکار کنم برات!",
        "عموت همیشه هست، پایه‌ی هرچی رفیق باعشقه!",
        "صدات پیچید تو کافه، حال دلم قشنگ شد!"
    ],
    "خداحافظ": [
        "برو ولی برگردا! جات همیشه خالیه کنار پنجره!",
        "مواظب خودت باش، قهوه بعدیت پای منه!",
        "بای بای، تا دیدار بعدی توی کافه رفیق!",
        "فعلاً رفیق، تو قلبم یه میز برات کنار گذاشتم!"
    ],
    "لطیفه": [
        "یه قهوه با شیر ازدواج کرد، بچه‌ش شد کاپوچینو!",
        "یه اسپرسو رفت خواستگاری، گفتن خیلی تلخی!"
    ],
    "تنهایی": [
        "تو تنها نیستی، عمو همیشه هست!",
        "بشین کنارم، باهم یه چیزی بخوریم و گپ بزنیم!",
        "تنهایی؟ بیا پیش عمو تنهاییت رو با یک فنجان قهوه با عمو تقسیم کن!"
    ],
    "عشق": [
        "عشق اومد تو کافه؟ یه قهوه دو نفره آماده‌ست!",
        "دل که دادی، شیرینی‌ش با عمو!",
        "عشق تلخه مثل اسپرسو، ولی قشنگه!",
        "بیا برات یه قهوه مخصوص عشق دم کنم!"
    ]
}

def preprocess_input(text):
    text = re.sub(r'\s+', ' ', text)
    text = text.replace('‌', ' ')
    text = text.replace('؟', '').replace('!', '')
    return text.strip().lower()

def get_response(text):
    processed = preprocess_input(text)
    
    # پاسخ‌های ویژه
    if processed == "/start":
        return ("سلام من عمو کافه چی هستم میتونید منو عمو صدا کنید، "
                "من یک ربات چت محور تلگرامی هستم که توسط عمو مهدی ساخته شدم "
                "تا همدم گروه‌های تلگرامی باشم و اگر پیشنهاد یا انتقادی برای من دارید به اون پیام بدید\n\n"
                "سرفصل ها:\nمنوی کلمات\nمنوی نوشیدنی\nسازنده")

    if processed == "منوی کلمات":
        return "\n".join([f"- {key}" for key in keywords.keys()])

    if processed == "منوی نوشیدنی":
        return "\n".join([f"- {drink}" for drink in beverages.keys()])

    if processed == "سازنده":
        return "Mehdi_mashih"

    if processed in beverages:
        return beverages[processed]

    for key, responses in keywords.items():
        if any(k in processed for k in key.split()):
            return random.choice(responses)

    return "متاسفانه متوجه منظورت نشدم عمو، یه بار دیگه بپرس!"

# هندل پیام دریافتی
def handle_message(update, context):
    text = update.message.text
    chat_id = update.message.chat_id
    response = get_response(text)
    context.bot.send_message(chat_id=chat_id, text=response)

# تنظیم هندلر
dispatcher.add_handler(MessageHandler(Filters.text & ~Filters.command, handle_message))

# webhook endpoint
@app.route(f"/{TOKEN}", methods=["POST"])
def webhook():
    update = telegram.Update.de_json(request.get_json(force=True), bot)
    dispatcher.process_update(update)
    return "ok"

# اجرای Flask روی پورت 5000
if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000, debug=True)
